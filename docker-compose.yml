# ============================================================================
# DOCKER COMPOSE: Redis для Uchat
# ============================================================================
# 
# Запуск Redis для кеширования и real-time функционала
# 
# ИСПОЛЬЗОВАНИЕ REDIS В UCHAT:
# 
# 1. КЕШИРОВАНИЕ
#    - Кеш пользовательских данных (профили, аватары)
#    - Кеш списка контактов
#    - Кеш информации о чатах
#    - TTL для автоматического истечения кеша
# 
# 2. REAL-TIME ФУНКЦИОНАЛ
#    - Pub/Sub для уведомлений о новых сообщениях
#    - Список активных пользователей (online/offline статус)
#    - Typing indicators ("печатает...")
#    - Read receipts (прочитано/доставлено)
# 
# 3. СЕССИИ
#    - Хранение токенов авторизации
#    - Управление сессиями пользователей
#    - Rate limiting (ограничение запросов)
# 
# ============================================================================
# КОМАНДЫ
# ============================================================================
# 
# Запуск:
#   docker-compose up -d
# 
# Остановка:
#   docker-compose down
# 
# Просмотр логов:
#   docker-compose logs -f redis
# 
# Перезапуск:
#   docker-compose restart redis
# 
# Подключение к Redis CLI:
#   docker-compose exec redis redis-cli
# 
# Проверка статуса:
#   docker-compose ps
# 
# ============================================================================

version: '3.8'

services:
  redis:
    image: redis:7.2-alpine
    container_name: uchat-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    command: >
      redis-server
      --appendonly yes
      --appendfsync everysec
      --maxmemory 256mb
      --maxmemory-policy allkeys-lru
      --save 900 1
      --save 300 10
      --save 60 10000
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 10s
    networks:
      - uchat-network

volumes:
  redis-data:
    driver: local
    name: uchat-redis-data

networks:
  uchat-network:
    driver: bridge
    name: uchat-network

# ============================================================================
# ПОЯСНЕНИЯ К ПАРАМЕТРАМ REDIS
# ============================================================================
# 
# --appendonly yes
#   Включает AOF (Append Only File) - логирование всех операций записи
#   Гарантирует сохранность данных при перезапуске
# 
# --appendfsync everysec
#   Синхронизация AOF каждую секунду (баланс производительность/надежность)
#   Альтернативы: always (медленнее), no (быстрее, но рискованнее)
# 
# --maxmemory 256mb
#   Максимальный размер памяти для Redis (256 МБ)
#   Для WPF приложения этого достаточно
#   При превышении срабатывает политика вытеснения
# 
# --maxmemory-policy allkeys-lru
#   LRU (Least Recently Used) - удаляет самые старые ключи при нехватке памяти
#   Подходит для кеша (автоматически очищает неактуальные данные)
# 
# --save 900 1
#   Сохранять снапшот на диск если прошло 900 секунд (15 минут) и был хотя бы 1 ключ изменен
# 
# --save 300 10
#   Сохранять снапшот если прошло 300 секунд (5 минут) и было изменено 10 ключей
# 
# --save 60 10000
#   Сохранять снапшот если прошло 60 секунд и было изменено 10000 ключей
# 
# ============================================================================
# МОНИТОРИНГ REDIS
# ============================================================================
# 
# Подключиться к Redis CLI:
#   docker-compose exec redis redis-cli
# 
# Полезные команды в Redis CLI:
# 
#   INFO                    # Общая информация о сервере
#   INFO stats              # Статистика
#   INFO memory             # Использование памяти
#   DBSIZE                  # Количество ключей
#   KEYS *                  # Список всех ключей (не для продакшена!)
#   MONITOR                 # Логирование всех команд в реальном времени
#   CLIENT LIST             # Список подключенных клиентов
#   SLOWLOG GET 10          # Последние 10 медленных запросов
#   CONFIG GET maxmemory    # Текущий лимит памяти
#   MEMORY USAGE key        # Сколько памяти занимает ключ
# 
# Примеры работы с кешем:
# 
#   SET user:100:name "Alice"         # Установить значение
#   GET user:100:name                 # Получить значение
#   EXPIRE user:100:name 3600         # Установить TTL 1 час
#   TTL user:100:name                 # Проверить оставшееся время
#   DEL user:100:name                 # Удалить ключ
#   FLUSHDB                           # Очистить текущую БД
# 
# Pub/Sub (уведомления):
# 
#   PUBLISH chat:1:messages "New message!"   # Отправить событие
#   SUBSCRIBE chat:1:messages                # Подписаться на события
# 
# ============================================================================
