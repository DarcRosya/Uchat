/*
 * ============================================================================
 * ENTITY MODEL: CHATROOM (Групповой чат)
 * ============================================================================
 * 
 * Это модель для групповых чатов (как группы в Telegram/WhatsApp).
 * 
 * ВАЖНО ПОНЯТЬ:
 * - Личные сообщения: User -> Message -> User (напрямую)
 * - Групповые сообщения: User -> Message -> ChatRoom <- ChatRoomMembers
 * 
 * ChatRoom это "контейнер" для группового общения.
 * Связь с участниками через промежуточную таблицу ChatRoomMembers.
 * 
 * ============================================================================
 */

namespace Uchat.Database.Entities;

/// <summary>
/// Модель группового чата (комнаты)
/// Представляет таблицу ChatRooms в базе данных
/// </summary>
public class ChatRoom
{
    // ========================================================================
    // PRIMARY KEY
    // ========================================================================
    
    /// <summary>
    /// Уникальный ID группового чата
    /// В БД: INTEGER PRIMARY KEY AUTOINCREMENT
    /// </summary>
    public int Id { get; set; }
    
    // ========================================================================
    // ОСНОВНАЯ ИНФОРМАЦИЯ О ГРУППЕ
    // ========================================================================
    
    /// <summary>
    /// Название группового чата
    /// В БД: VARCHAR(100) NOT NULL
    /// 
    /// Примеры:
    ///   - "Рабочий чат команды"
    ///   - "Друзья из университета"
    ///   - "Обсуждение проекта Uchat"
    /// </summary>
    public string Name { get; set; } = string.Empty;
    
    /// <summary>
    /// Описание группы (опциональное)
    /// В БД: VARCHAR(500) NULL
    /// 
    /// Например: "Обсуждаем разработку чата на C#. Присоединяйтесь!"
    /// </summary>
    public string? Description { get; set; }
    
    /// <summary>
    /// URL аватара группы (картинка/иконка)
    /// В БД: VARCHAR(500) NULL
    /// 
    /// Примеры:
    ///   - "/uploads/groups/avatar_42.png"
    ///   - "https://cdn.example.com/group_icons/team.jpg"
    /// </summary>
    public string? AvatarUrl { get; set; }
    
    // ========================================================================
    // СОЗДАТЕЛЬ И МЕТАДАННЫЕ
    // ========================================================================
    
    /// <summary>
    /// ID пользователя, который создал эту группу
    /// Foreign Key -> Users.Id
    /// В БД: INTEGER NOT NULL
    /// 
    /// Создатель обычно автоматически получает роль Owner
    /// </summary>
    public int CreatorId { get; set; }
    
    /// <summary>
    /// Когда группа была создана
    /// В БД: DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP
    /// </summary>
    public DateTime CreatedAt { get; set; }
    
    // ========================================================================
    // НАСТРОЙКИ ГРУППЫ
    // ========================================================================
    
    /// <summary>
    /// Тип группы (приватная или публичная)
    /// В БД: INTEGER NOT NULL
    /// 
    /// Private (0) = только по приглашению
    /// Public (1) = любой может найти и присоединиться
    /// </summary>
    public ChatRoomType Type { get; set; }
    
    /// <summary>
    /// Максимальное количество участников в группе
    /// В БД: INTEGER NULL
    /// 
    /// NULL = без ограничений
    /// Например: 100, 500, 10000
    /// 
    /// Используется для:
    /// - Контроля размера группы
    /// - Монетизации (бесплатно до 100 человек, платно - больше)
    /// </summary>
    public int? MaxMembers { get; set; }
    
    /// <summary>
    /// Архивирована ли группа
    /// В БД: BOOLEAN NOT NULL DEFAULT 0
    /// 
    /// Архивированные группы:
    /// - Не показываются в основном списке
    /// - Нельзя отправлять новые сообщения
    /// - История сохраняется
    /// - Можно разархивировать
    /// </summary>
    public bool IsArchived { get; set; }
    
    // ========================================================================
    // НАВИГАЦИОННЫЕ СВОЙСТВА
    // ========================================================================
    
    /// <summary>
    /// Создатель группы
    /// 
    /// Navigation property для CreatorId
    /// 
    /// Использование:
    ///   var chatRoom = await context.ChatRooms
    ///       .Include(cr => cr.Creator)
    ///       .FirstAsync(cr => cr.Id == 5);
    ///   
    ///   Console.WriteLine($"Создатель: {chatRoom.Creator.Username}");
    /// </summary>
    public User Creator { get; set; } = null!;

    // ПРИМЕЧАНИЕ: Сообщения в этом чате хранятся в MongoDB!
    // Связь: MongoMessage.ChatId == ChatRoom.Id
    // Для получения сообщений используй MongoMessageRepository:
    //   var messages = await mongoRepo.GetChatMessagesAsync(chatRoom.Id, limit: 50);
    
    /// <summary>
    /// Все участники этой группы
    /// 
    /// Связь: ChatRoom (1) -> ChatRoomMember (Many) -> User (1)
    /// Это Many-to-Many через промежуточную таблицу
    /// 
    /// ПОЧЕМУ ЧЕРЕЗ ПРОМЕЖУТОЧНУЮ ТАБЛИЦУ?
    /// Потому что нам нужно хранить дополнительную информацию о членстве:
    /// - Когда присоединился
    /// - Роль (админ, модератор, обычный участник)
    /// - Кто пригласил
    /// - Заблокирован ли в группе
    /// 
    /// Использование:
    ///   var chatRoom = await context.ChatRooms
    ///       .Include(cr => cr.Members)
    ///           .ThenInclude(m => m.User)  // Загружаем самих пользователей
    ///       .FirstAsync(cr => cr.Id == 5);
    ///   
    ///   foreach (var member in chatRoom.Members) {
    ///       Console.WriteLine($"{member.User.Username} - {member.Role}");
    ///   }
    /// </summary>
    public ICollection<ChatRoomMember> Members { get; set; } = new List<ChatRoomMember>();
}

// ============================================================================
// ENUM: CHATROOM TYPE (Тип группы)
// ============================================================================

/// <summary>
/// Тип группового чата
/// Хранится в БД как INTEGER
/// </summary>
public enum ChatRoomType
{
    /// <summary>
    /// Приватная группа
    /// - Нельзя найти через поиск
    /// - Только по приглашению от участников
    /// - Требуется одобрение админа (опционально)
    /// </summary>
    Private = 0,
    
    /// <summary>
    /// Публичная группа
    /// - Можно найти через поиск
    /// - Любой может присоединиться
    /// - Видна в каталоге групп
    /// </summary>
    Public = 1
}
