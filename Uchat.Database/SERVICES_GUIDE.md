# Uchat Services Guide

## üìã –û–±–∑–æ—Ä –∏–∑–º–µ–Ω–µ–Ω–∏–π

### ‚úÖ –ß—Ç–æ –±—ã–ª–æ –∏–∑–º–µ–Ω–µ–Ω–æ:

1. **MessagingCoordinator ‚Üí MessageService**
2. **Backup —Ä–µ–∂–∏–º—ã: Manual / Automatic**
3. **–£–¥–∞–ª–µ–Ω—ã: Cleanup Service, Cloud Uploaders**

---

## 1Ô∏è‚É£ MessageService (–±—ã–≤—à–∏–π MessagingCoordinator)

### üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:
–£–ø—Ä–∞–≤–ª—è–µ—Ç –æ—Ç–ø—Ä–∞–≤–∫–æ–π —Å–æ–æ–±—â–µ–Ω–∏–π —Å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏–µ–π –º–µ–∂–¥—É:
- **SQLite** (–º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —á–∞—Ç–æ–≤, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏)
- **LiteDB** (–∫–æ–Ω—Ç–µ–Ω—Ç —Å–æ–æ–±—â–µ–Ω–∏–π)

### ‚ú® –ß—Ç–æ –¥–µ–ª–∞–µ—Ç:

```csharp
public interface IMessageService
{
    Task<MessagingResult> SendMessageAsync(MessageCreateDto dto, CancellationToken cancellationToken = default);
}
```

#### **–®–∞–≥–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏:**

1. **–í–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞:**
   - ‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –ø—É—Å—Ç–æ–µ –ò–õ–ò –µ—Å—Ç—å –≤–ª–æ–∂–µ–Ω–∏—è
   - ‚úÖ –¢–µ–∫—Å—Ç ‚â§ 5000 —Å–∏–º–≤–æ–ª–æ–≤
   - ‚úÖ –í–ª–æ–∂–µ–Ω–∏–π ‚â§ 10 —à—Ç—É–∫

2. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞:**
   - ‚úÖ –ß–∞—Ç —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
   - ‚úÖ –û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å —É—á–∞—Å—Ç–Ω–∏–∫ —á–∞—Ç–∞
   - ‚úÖ –û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å –∏–º–µ–µ—Ç –ø—Ä–∞–≤–æ –ø–∏—Å–∞—Ç—å (–Ω–µ –≤ –º—É—Ç–µ)

3. **–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ:**
   ```csharp
   BEGIN TRANSACTION (SQLite)
       - –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ LiteDB
       - –û–±–Ω–æ–≤–∏—Ç—å LastActivityAt –≤ ChatRoom
       - –û–±–Ω–æ–≤–∏—Ç—å TotalMessagesCount
       - –û–±–Ω–æ–≤–∏—Ç—å Contact.MessageCount
   COMMIT –∏–ª–∏ ROLLBACK
   ```

4. **–û—Ç–∫–∞—Ç –ø—Ä–∏ –æ—à–∏–±–∫–µ:**
   - –ï—Å–ª–∏ SQLite —É–ø–∞–ª ‚Üí —É–¥–∞–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–∑ LiteDB
   - –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

### üìù –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:

```csharp
// –í SignalR Hub –∏–ª–∏ Controller:
public class ChatHub : Hub
{
    private readonly IMessageService _messageService;

    public async Task SendMessage(int chatId, string content)
    {
        var dto = new MessageCreateDto
        {
            ChatRoomId = chatId,
            SenderId = GetCurrentUserId(),
            Content = content,
            Type = "text"
        };

        var result = await _messageService.SendMessageAsync(dto);

        if (result.Success)
        {
            await Clients.Group($"chat-{chatId}").SendAsync("NewMessage", new
            {
                messageId = result.MessageId,
                sentAt = result.SentAt
            });
        }
        else
        {
            await Clients.Caller.SendAsync("Error", result.FailureReason);
        }
    }
}
```

### üîß –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –≤–∞–ª–∏–¥–∞—Ü–∏–∏:

```csharp
private const int MaxMessageLength = 5000;    // –º–∞–∫—Å. –¥–ª–∏–Ω–∞ —Ç–µ–∫—Å—Ç–∞
private const int MaxAttachments = 10;        // –º–∞–∫—Å. –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–ª–æ–∂–µ–Ω–∏–π
```

### ‚ö†Ô∏è –í–æ–∑–º–æ–∂–Ω—ã–µ –æ—à–∏–±–∫–∏:

| –û—à–∏–±–∫–∞ | –ü—Ä–∏—á–∏–Ω–∞ |
|--------|---------|
| `Message must have either content or attachments` | –ü—É—Å—Ç–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –±–µ–∑ —Ñ–∞–π–ª–æ–≤ |
| `Message content exceeds maximum length` | –¢–µ–∫—Å—Ç > 5000 —Å–∏–º–≤–æ–ª–æ–≤ |
| `Message cannot have more than X attachments` | –í–ª–æ–∂–µ–Ω–∏–π > 10 |
| `ChatRoom X not found` | –ß–∞—Ç–∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç |
| `Sender is not a member of the chat` | –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —É—á–∞—Å—Ç–Ω–∏–∫ |
| `You don't have permission to send messages` | –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –º—É—Ç–µ |

---

## 2Ô∏è‚É£ LiteDB Backup Service

### üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:
–°–æ–∑–¥–∞—ë—Ç —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π LiteDB.

### üîÑ –†–µ–∂–∏–º—ã —Ä–∞–±–æ—Ç—ã:

#### **Manual Mode** (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é):
```json
{
  "LiteDb": {
    "BackupMode": "Manual"
  }
}
```

- ‚è∏Ô∏è –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –±—ç–∫–∞–ø—ã **–û–¢–ö–õ–Æ–ß–ï–ù–´**
- üñêÔ∏è –°–æ–∑–¥–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ –≤—ã–∑–æ–≤—É API
- ‚úÖ **–î–ª—è –≤–∞—Å:** –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–µ 24/7, –±—ç–∫–∞–ø—ã –¥–µ–ª–∞–µ—Ç–µ —Å–∞–º–∏

**–ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:**

```csharp
public class BackupController : ControllerBase
{
    private readonly LiteDbBackupService _backupService;

    [HttpPost("api/backup/create")]
    public async Task<IActionResult> CreateBackup()
    {
        await _backupService.CreateBackupNowAsync();
        return Ok("Backup created");
    }
}
```

#### **Automatic Mode:**
```json
{
  "LiteDb": {
    "BackupMode": "Automatic",
    "BackupIntervalMinutes": 1440  // —Ä–∞–∑ –≤ —Å—É—Ç–∫–∏
  }
}
```

- üîÑ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –±—ç–∫–∞–ø—ã –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é
- ‚è∞ –ö–∞–∂–¥—ã–µ 1440 –º–∏–Ω—É—Ç (24 —á–∞—Å–∞) –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
- ‚úÖ **–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:** production —Å–µ—Ä–≤–µ—Ä 24/7

### üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –±—ç–∫–∞–ø–æ–≤:

```
Backups/
‚îú‚îÄ‚îÄ messages-20251125120000.db.bak  (–ø–æ—Å–ª–µ–¥–Ω–∏–π)
‚îú‚îÄ‚îÄ messages-20251124120000.db.bak
‚îú‚îÄ‚îÄ messages-20251123120000.db.bak
‚îî‚îÄ‚îÄ ... (—Ö—Ä–∞–Ω–∏—Ç—Å—è 7 —à—Ç—É–∫)
```

### üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∏:

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –û–ø–∏—Å–∞–Ω–∏–µ | –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é |
|----------|----------|----------------------|
| `BackupMode` | Manual –∏–ª–∏ Automatic | `"Manual"` |
| `BackupDirectory` | –ü–∞–ø–∫–∞ –¥–ª—è –±—ç–∫–∞–ø–æ–≤ | `"Backups"` |
| `BackupRetention` | –°–∫–æ–ª—å–∫–æ –±—ç–∫–∞–ø–æ–≤ —Ö—Ä–∞–Ω–∏—Ç—å | `7` |
| `BackupIntervalMinutes` | –ò–Ω—Ç–µ—Ä–≤–∞–ª (—Ç–æ–ª—å–∫–æ Automatic) | `1440` (1 –¥–µ–Ω—å) |

### üõ°Ô∏è –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ –±—ç–∫–∞–ø–∞:

```csharp
// –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–∑ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –±—ç–∫–∞–ø–∞:
await _backupService.RestoreAsync("messages-20251125120000.db.bak");
```

‚ö†Ô∏è **–í–∞–∂–Ω–æ:** 
- –ë—ç–∫–∞–ø—ã —Å–æ–∑–¥–∞—é—Ç—Å—è —Å –±–ª–æ–∫–∏—Ä–æ–≤–∫–æ–π –∑–∞–ø–∏—Å–∏ (`ILiteDbWriteGate`)
- –°—Ç–∞—Ä—ã–µ –±—ç–∫–∞–ø—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è—é—Ç—Å—è (rotation)
- –í—Å–µ –±—ç–∫–∞–ø—ã **–ª–æ–∫–∞–ª—å–Ω—ã–µ** (–Ω–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –≤ –æ–±–ª–∞–∫–æ)

---

## 3Ô∏è‚É£ –ß—Ç–æ –±—ã–ª–æ –£–î–ê–õ–ï–ù–û:

### ‚ùå MessageCleanupService
- **–ü—Ä–∏—á–∏–Ω–∞:** –ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä—ã —Ö—Ä–∞–Ω—è—Ç –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é
- **–ê–Ω–∞–ª–æ–≥–∏:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∞–º —É–¥–∞–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è

### ‚ùå ILiteDbBackupUploader + NoOpLiteDbBackupUploader
- **–ü—Ä–∏—á–∏–Ω–∞:** –ë—ç–∫–∞–ø—ã –ª–æ–∫–∞–ª—å–Ω—ã–µ, –æ–±–ª–∞–∫–æ –Ω–µ –Ω—É–∂–Ω–æ
- **–ê–Ω–∞–ª–æ–≥–∏:** –ï—Å–ª–∏ –Ω—É–∂–Ω–æ –≤ –æ–±–ª–∞–∫–æ ‚Üí –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `rclone` –∏–ª–∏ —Å–∏—Å—Ç–µ–º–Ω—ã–µ —Å–∫—Ä–∏–ø—Ç—ã

### ‚ùå ILiteDbWriteGate (–æ—Å—Ç–∞–≤–ª–µ–Ω, –Ω–æ —É–ø—Ä–æ—â—ë–Ω)
- **–ü—Ä–∏—á–∏–Ω–∞:** LiteDB —É–∂–µ thread-safe
- **–°—Ç–∞—Ç—É—Å:** –û—Å—Ç–∞–≤–ª–µ–Ω –¥–ª—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏–∏ –±—ç–∫–∞–ø–æ–≤

---

## üìä –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:

```
SignalR Hub / Controller
        ‚Üì
   MessageService  ‚Üê –í–∞–ª–∏–¥–∞—Ü–∏—è + –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞
        ‚Üì
    ‚îå‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚Üì        ‚Üì
SQLite   LiteDB
(users)  (messages)
    ‚Üì        ‚Üì
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îò
         ‚Üì
   –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è
```

---

## üöÄ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ DI:

```csharp
// Program.cs –∏–ª–∏ Startup.cs
services.AddDbContext<UchatDbContext>();
services.AddSingleton<LiteDbContext>();
services.AddScoped<IMessageRepository, MessageRepository>();

// –í–ê–ñ–ù–û: –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–ª–∏!
services.AddScoped<IMessageService, MessageService>();  // –±—ã–ª–æ IMessagingCoordinator

// Backup service (—Ä–∞–±–æ—Ç–∞–µ—Ç –≤ —Ñ–æ–Ω–µ)
services.AddSingleton<ILiteDbWriteGate, LiteDbWriteGate>();
services.AddHostedService<LiteDbBackupService>();
```

---

## üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:

### ‚úÖ –ß—Ç–æ –¥–µ–ª–∞—Ç—å –ü–†–ê–í–ò–õ–¨–ù–û:

1. **–í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞ —É—Ä–æ–≤–Ω–µ Service:**
   ```csharp
   // ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ:
   var result = await _messageService.SendMessageAsync(dto);
   if (!result.Success) { /* –æ–±—Ä–∞–±–æ—Ç–∫–∞ */ }
   
   // ‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ:
   await _messageRepository.CreateAsync(msg); // –±–µ–∑ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
   ```

2. **–ë—ç–∫–∞–ø—ã –≤ Manual —Ä–µ–∂–∏–º–µ:**
   ```json
   "BackupMode": "Manual"  // –¥–ª—è dev/—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
   ```

3. **–ë—ç–∫–∞–ø—ã –≤ Automatic –¥–ª—è production:**
   ```json
   "BackupMode": "Automatic",
   "BackupIntervalMinutes": 1440  // —Ä–∞–∑ –≤ –¥–µ–Ω—å
   ```

### ‚ö†Ô∏è –ß–µ–≥–æ –ù–ï –¥–µ–ª–∞—Ç—å:

1. ‚ùå –ù–µ –æ–±—Ö–æ–¥–∏—Ç–µ `MessageService` - –≤—Å–µ–≥–¥–∞ –≤–∞–ª–∏–¥–∏—Ä—É–π—Ç–µ
2. ‚ùå –ù–µ —Ö—Ä–∞–Ω–∏—Ç–µ –±—ç–∫–∞–ø—ã –≤–µ—á–Ω–æ - –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `BackupRetention`
3. ‚ùå –ù–µ –ø–æ–ª–∞–≥–∞–π—Ç–µ—Å—å –Ω–∞ –±—ç–∫–∞–ø—ã –¥–ª—è crash recovery - –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ LiteDB –∂—É—Ä–Ω–∞–ª–∏—Ä–æ–≤–∞–Ω–∏–µ

---

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ:

### –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–æ—Ç–µ—Ä–∏ –¥–∞–Ω–Ω—ã—Ö:

1. **LiteDB Journal** (–≤—Å—Ç—Ä–æ–µ–Ω–Ω–æ–µ):
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ –∫—Ä–∞—à–∞
   - RPO = 0 —Å–µ–∫—É–Ω–¥

2. **Backup Service**:
   - –ó–∞—â–∏—Ç–∞ –æ—Ç —Å–ª—É—á–∞–π–Ω–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è
   - Disaster recovery
   - RPO = –∏–Ω—Ç–µ—Ä–≤–∞–ª –±—ç–∫–∞–ø–∞ (24 —á–∞—Å–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)

3. **–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ SQLite + LiteDB**:
   - –ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –º–µ–∂–¥—É –ë–î
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π rollback –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

### –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —á—Ç–æ:

| –°—Ü–µ–Ω–∞—Ä–∏–π | –†–µ—à–µ–Ω–∏–µ |
|----------|---------|
| –°–µ—Ä–≤–µ—Ä —É–ø–∞–ª | LiteDB Journal (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏) |
| –£–¥–∞–ª–∏–ª–∏ —á–∞—Ç –ø–æ –æ—à–∏–±–∫–µ | Restore –∏–∑ –±—ç–∫–∞–ø–∞ |
| –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ | Manual backups |
| Production 24/7 | Automatic backups |
| –ú–∏–≥—Ä–∞—Ü–∏—è –Ω–∞ –Ω–æ–≤—ã–π —Å–µ—Ä–≤–µ—Ä | –ö–æ–ø–∏—Ä—É–µ–º Data/ —Ü–µ–ª–∏–∫–æ–º |

---

## üéØ –ò—Ç–æ–≥–æ:

- ‚úÖ **MessageService** - –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏—è
- ‚úÖ **Manual/Automatic –±—ç–∫–∞–ø—ã** - –≥–∏–±–∫–æ—Å—Ç—å –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤
- ‚úÖ **–£–ø—Ä–æ—â—ë–Ω–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞** - –±–µ–∑ –ª–∏—à–Ω–∏—Ö –∞–±—Å—Ç—Ä–∞–∫—Ü–∏–π
- ‚úÖ **–õ–æ–∫–∞–ª—å–Ω—ã–µ –±—ç–∫–∞–ø—ã** - –±–µ–∑ –æ–±–ª–∞—á–Ω—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
