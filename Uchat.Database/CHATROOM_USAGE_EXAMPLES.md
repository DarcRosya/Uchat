# üìñ ChatRoom - –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

## üéØ –ö–æ–Ω—Ü–µ–ø—Ü–∏—è: –í–°–ï —á–∞—Ç—ã —á–µ—Ä–µ–∑ –æ–¥–∏–Ω –∫–ª–∞—Å—Å ChatRoom

**–¢–≤–æ–π –≤–æ–ø—Ä–æ—Å –±—ã–ª –∞–±—Å–æ–ª—é—Ç–Ω–æ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π!** –ú—ã —Å–¥–µ–ª–∞–ª–∏ —Ç–∞–∫, —á—Ç–æ **–ª—é–±–æ–π —á–∞—Ç** (–ª–∏—á–Ω—ã–π, –≥—Ä—É–ø–ø–∞, –∫–∞–Ω–∞–ª, —Ç–æ–ø–∏–∫) —Ö—Ä–∞–Ω–∏—Ç—Å—è —á–µ—Ä–µ–∑ **–æ–¥–∏–Ω –∫–ª–∞—Å—Å ChatRoom**.

### ‚úÖ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –µ–¥–∏–Ω–æ–≥–æ –∫–ª–∞—Å—Å–∞:
1. **–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ—Å—Ç—å** - –æ–¥–Ω–∏ –∏ —Ç–µ –∂–µ –º–µ—Ç–æ–¥—ã –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ —á–∞—Ç–æ–≤
2. **–ì–∏–±–∫–æ—Å—Ç—å** - –ª–µ–≥–∫–æ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ —Ç–∏–ø—ã (—Å—É–ø–µ—Ä–≥—Ä—É–ø–ø—ã, —Ñ–æ—Ä—É–º—ã)
3. **–ü—Ä–æ—Å—Ç–æ—Ç–∞** - –Ω–µ –Ω—É–∂–Ω–æ –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥ –¥–ª—è `DirectChats`, `Groups`, `Channels`
4. **–†–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å** - –Ω–æ–≤—ã–µ –ø–æ–ª—è –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑

---

## üìä –¢–∏–ø—ã —á–∞—Ç–æ–≤

| –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ | –£—á–∞—Å—Ç–Ω–∏–∫–∏ | –ö—Ç–æ –º–æ–∂–µ—Ç –ø–∏—Å–∞—Ç—å | –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ |
|-----|----------|-----------|------------------|-------------|
| **DirectMessage** | –õ–∏—á–Ω—ã–π —á–∞—Ç 1-on-1 | –í—Å–µ–≥–¥–∞ 2 | –û–±–∞ | –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–≥–Ω–æ—Ä–∏—Ä—É—é—Ç—Å—è |
| **Private** | –ü—Ä–∏–≤–∞—Ç–Ω–∞—è –≥—Ä—É–ø–ø–∞ | –ú–Ω–æ–≥–æ | –ü–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º | –¢–æ–ª—å–∫–æ –ø–æ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—é |
| **Public** | –ü—É–±–ª–∏—á–Ω–∞—è –≥—Ä—É–ø–ø–∞ | –ú–Ω–æ–≥–æ | –ü–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º | –ú–æ–∂–Ω–æ –Ω–∞–π—Ç–∏ –∏ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è |
| **Channel** | –ö–∞–Ω–∞–ª | –ú–Ω–æ–≥–æ | –¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω—ã | AllowMembersToSendMessages = false |
| **Topic** | –¢–æ–ø–∏–∫ –≤ –≥—Ä—É–ø–ø–µ | –ù–∞—Å–ª–µ–¥—É—é—Ç—Å—è | –ü–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º | ParentChatRoomId != null |

---

## 1Ô∏è‚É£ DirectMessage - –õ–∏—á–Ω—ã–π —á–∞—Ç

### –°–æ–∑–¥–∞–Ω–∏–µ –ª–∏—á–Ω–æ–≥–æ —á–∞—Ç–∞

```csharp
// ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å extension method
var chat = await context.GetOrCreateDirectChatAsync(user1Id, user2Id);

// –ï—Å–ª–∏ —á–∞—Ç —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç - –≤–µ—Ä–Ω—ë—Ç—Å—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π
// –ï—Å–ª–∏ –Ω–µ—Ç - —Å–æ–∑–¥–∞—Å—Ç—Å—è –Ω–æ–≤—ã–π —Å –¥–≤—É–º—è —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ —á–∞—Ç–∞

```csharp
var existingChat = await context.ChatRooms
    .Include(cr => cr.Members)
    .Where(cr => cr.Type == ChatRoomType.DirectMessage)
    .Where(cr => cr.Members.Any(m => m.UserId == user1Id))
    .Where(cr => cr.Members.Any(m => m.UserId == user2Id))
    .FirstOrDefaultAsync();

if (existingChat == null) {
    Console.WriteLine("–ß–∞—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω, –Ω—É–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å");
} else {
    Console.WriteLine($"–ß–∞—Ç —Å—É—â–µ—Å—Ç–≤—É–µ—Ç: ID = {existingChat.Id}");
}
```

### –í–∞–ª–∏–¥–∞—Ü–∏—è DirectMessage

```csharp
// –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —É—á–∞—Å—Ç–Ω–∏–∫–∞
if (chatRoom.Type == ChatRoomType.DirectMessage) {
    var currentMembersCount = await context.ChatRoomMembers
        .CountAsync(m => m.ChatRoomId == chatRoomId);
    
    if (currentMembersCount >= 2) {
        throw new InvalidOperationException("DirectMessage can only have 2 members");
    }
}
```

### –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ DirectMessage:
- ‚úÖ `AllowMembersToInvite` ‚Üí –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è (–≤—Å–µ–≥–¥–∞ `false`)
- ‚úÖ `AllowMembersToSendMessages` ‚Üí –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è (–≤—Å–µ–≥–¥–∞ `true`)
- ‚úÖ `AllowMembersToSendMedia` ‚Üí –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è (–≤—Å–µ–≥–¥–∞ `true`)
- ‚úÖ `SlowModeSeconds` ‚Üí –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è (–≤—Å–µ–≥–¥–∞ `null`)
- ‚úÖ `MaxMembers` ‚Üí –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è (–≤—Å–µ–≥–¥–∞ 2)

---

## 2Ô∏è‚É£ Private/Public Group - –ì—Ä—É–ø–ø—ã

### –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–∏–≤–∞—Ç–Ω–æ–π –≥—Ä—É–ø–ø—ã

```csharp
// –°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É
var group = new ChatRoom {
    Type = ChatRoomType.Private,
    Name = "Dev Team",
    Description = "–û–±—Å—É–∂–¥–µ–Ω–∏–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞",
    CreatorId = userId,
    CreatedAt = DateTime.UtcNow,
    
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∏
    AllowMembersToInvite = false,      // –¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω—ã –ø—Ä–∏–≥–ª–∞—à–∞—é—Ç
    AllowMembersToSendMessages = true, // –í—Å–µ –º–æ–≥—É—Ç –ø–∏—Å–∞—Ç—å
    AllowMembersToSendMedia = true,    // –ú–µ–¥–∏–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω—ã
    SlowModeSeconds = null,            // –ë–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π
    MaxMembers = 200
};
context.ChatRooms.Add(group);
await context.SaveChangesAsync();

// –î–æ–±–∞–≤–∏—Ç—å —Å–æ–∑–¥–∞—Ç–µ–ª—è –∫–∞–∫ Owner
context.ChatRoomMembers.Add(new ChatRoomMember {
    ChatRoomId = group.Id,
    UserId = userId,
    Role = ChatRoomRole.Owner,
    JoinedAt = DateTime.UtcNow
});
await context.SaveChangesAsync();
```

### –°–æ–∑–¥–∞–Ω–∏–µ –ø—É–±–ª–∏—á–Ω–æ–π –≥—Ä—É–ø–ø—ã

```csharp
var publicGroup = new ChatRoom {
    Type = ChatRoomType.Public,
    Name = "Ukrainian Developers",
    Description = "Community of Ukrainian developers",
    CreatorId = userId,
    
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –ø—É–±–ª–∏—á–Ω–æ–π –≥—Ä—É–ø–ø—ã
    AllowMembersToInvite = true,       // –õ—é–±–æ–π –º–æ–∂–µ—Ç –ø—Ä–∏–≥–ª–∞—à–∞—Ç—å
    AllowMembersToSendMessages = true,
    SlowModeSeconds = 5                // 1 —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ 5 —Å–µ–∫—É–Ω–¥ (–∞–Ω—Ç–∏—Å–ø–∞–º)
};
```

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–∞ –≤ –≥—Ä—É–ø–ø—É

```csharp
// –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–∏–º–∏—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
var currentCount = await context.ChatRoomMembers
    .CountAsync(m => m.ChatRoomId == groupId);

if (group.MaxMembers.HasValue && currentCount >= group.MaxMembers.Value) {
    throw new InvalidOperationException("Group is full");
}

// –î–æ–±–∞–≤–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞
var member = new ChatRoomMember {
    ChatRoomId = groupId,
    UserId = newUserId,
    Role = ChatRoomRole.Member,
    JoinedAt = DateTime.UtcNow,
    InvitedById = inviterUserId
};
context.ChatRoomMembers.Add(member);
await context.SaveChangesAsync();
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π —Å–æ–æ–±—â–µ–Ω–∏—è

```csharp
// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å extension method
if (!await context.CanUserSendMessageAsync(groupId, userId)) {
    return BadRequest("You cannot send messages in this group");
}

// –î–ª—è –º–µ–¥–∏–∞
if (hasAttachment && !await context.CanUserSendMediaAsync(groupId, userId)) {
    return BadRequest("Media is not allowed in this group");
}
```

---

## 3Ô∏è‚É£ Channel - –ö–∞–Ω–∞–ª

### –°–æ–∑–¥–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞

```csharp
var channel = new ChatRoom {
    Type = ChatRoomType.Channel,
    Name = "Tech News",
    Description = "Latest news from tech world",
    CreatorId = userId,
    
    // ‚ö†Ô∏è –í–ê–ñ–ù–û: –í –∫–∞–Ω–∞–ª–∞—Ö —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω—ã –ø–∏—à—É—Ç!
    AllowMembersToSendMessages = false,  // ‚Üê –ö–ª—é—á–µ–≤–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞
    AllowMembersToSendMedia = false,     // –¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω—ã
    MaxMembers = 100000                  // –ö–∞–Ω–∞–ª—ã –º–æ–≥—É—Ç –±—ã—Ç—å –±–æ–ª—å—à–∏–º–∏
};
context.ChatRooms.Add(channel);
await context.SaveChangesAsync();

// –°–æ–∑–¥–∞—Ç–µ–ª—å —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è Owner
context.ChatRoomMembers.Add(new ChatRoomMember {
    ChatRoomId = channel.Id,
    UserId = userId,
    Role = ChatRoomRole.Owner
});
await context.SaveChangesAsync();
```

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤ (–Ω–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤!)

```csharp
// –í –∫–∞–Ω–∞–ª–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏ = –ø–æ–¥–ø–∏—Å—á–∏–∫–∏ (subscribers)
// –û–Ω–∏ —Ç–æ–ª—å–∫–æ —á–∏—Ç–∞—é—Ç, –Ω–µ –ø–∏—à—É—Ç
var subscriber = new ChatRoomMember {
    ChatRoomId = channelId,
    UserId = subscriberId,
    Role = ChatRoomRole.Member,  // –û–±—ã—á–Ω—ã–π member = –ø–æ–¥–ø–∏—Å—á–∏–∫
    JoinedAt = DateTime.UtcNow
};
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–ª—è –∫–∞–Ω–∞–ª–∞

```csharp
var member = await context.ChatRoomMembers
    .FirstAsync(m => m.ChatRoomId == channelId && m.UserId == userId);

// –í –∫–∞–Ω–∞–ª–µ –ø–∏—Å–∞—Ç—å –º–æ–≥—É—Ç —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω—ã/–≤–ª–∞–¥–µ–ª—å—Ü—ã
if (member.Role != ChatRoomRole.Admin && member.Role != ChatRoomRole.Owner) {
    throw new ForbiddenException("Only admins can post in channels");
}
```

---

## 4Ô∏è‚É£ Topic - –¢–æ–ø–∏–∫ –≤–Ω—É—Ç—Ä–∏ –≥—Ä—É–ø–ø—ã

### –°–æ–∑–¥–∞–Ω–∏–µ —Ç–æ–ø–∏–∫–∞

```csharp
// –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —Ä–æ–¥–∏—Ç–µ–ª—å –º–æ–∂–µ—Ç –∏–º–µ—Ç—å —Ç–æ–ø–∏–∫–∏
var parentGroup = await context.ChatRooms.FindAsync(parentGroupId);

if (!parentGroup.CanHaveTopics()) {
    throw new InvalidOperationException("This chat type cannot have topics");
}

// –°–æ–∑–¥–∞—Ç—å —Ç–æ–ø–∏–∫
var topic = new ChatRoom {
    Type = ChatRoomType.Topic,
    Name = "General Discussion",
    ParentChatRoomId = parentGroupId,  // ‚Üê –°–≤—è–∑—å —Å –≥—Ä—É–ø–ø–æ–π
    CreatorId = userId,
    CreatedAt = DateTime.UtcNow,
    
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –º–æ–∂–Ω–æ –∑–∞–¥–∞—Ç—å –∏–ª–∏ –æ—Å—Ç–∞–≤–∏—Ç—å null (–Ω–∞—Å–ª–µ–¥—É—é—Ç—Å—è –æ—Ç —Ä–æ–¥–∏—Ç–µ–ª—è)
    AllowMembersToSendMessages = null  // null = –Ω–∞—Å–ª–µ–¥–æ–≤–∞—Ç—å –æ—Ç —Ä–æ–¥–∏—Ç–µ–ª—è
};
context.ChatRooms.Add(topic);
await context.SaveChangesAsync();
```

### –ü–æ–ª—É—á–µ–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —Ç–æ–ø–∏–∫–∞

```csharp
// ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û: –£—á–∞—Å—Ç–Ω–∏–∫–∏ –Ω–∞—Å–ª–µ–¥—É—é—Ç—Å—è –æ—Ç —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–π –≥—Ä—É–ø–ø—ã
var members = await context.GetTopicMembersAsync(topicId);

foreach (var user in members) {
    Console.WriteLine($"- {user.Username}");
}

// ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û: –ò—Å–∫–∞—Ç—å –≤ ChatRoomMembers –¥–ª—è —Ç–æ–ø–∏–∫–∞
// –£ —Ç–æ–ø–∏–∫–∞ –ù–ï–¢ —Å–≤–æ–∏—Ö –∑–∞–ø–∏—Å–µ–π –≤ ChatRoomMembers!
// –£—á–∞—Å—Ç–Ω–∏–∫–∏ –±–µ—Ä—É—Ç—Å—è –∏–∑ ParentChatRoom.Members
```

### –ü–æ–ª—É—á–µ–Ω–∏–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Ç–æ–ø–∏–∫–∞

```csharp
var topic = await context.ChatRooms
    .Include(cr => cr.ParentChatRoom)
    .FirstAsync(cr => cr.Id == topicId);

// –ï—Å–ª–∏ —É —Ç–æ–ø–∏–∫–∞ —Å–≤–æ–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏—Ö
// –ï—Å–ª–∏ null - –≤–∑—è—Ç—å –æ—Ç —Ä–æ–¥–∏—Ç–µ–ª—è
bool canWrite = topic.GetEffectiveAllowMembersToSendMessages();
bool canInvite = topic.GetEffectiveAllowMembersToInvite();
int? slowMode = topic.GetEffectiveSlowModeSeconds();

Console.WriteLine($"Can write: {canWrite}");
Console.WriteLine($"Slow mode: {slowMode ?? 0} seconds");
```

### –ü—Ä–∏–º–µ—Ä: –ó–∞–∫—Ä—ã—Ç—ã–π —Ç–æ–ø–∏–∫ –≤–Ω—É—Ç—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–æ–π –≥—Ä—É–ø–ø—ã

```csharp
// –ì—Ä—É–ø–ø–∞: –≤—Å–µ –º–æ–≥—É—Ç –ø–∏—Å–∞—Ç—å
var group = new ChatRoom {
    Type = ChatRoomType.Private,
    Name = "Dev Team",
    AllowMembersToSendMessages = true  // ‚Üê –í—Å–µ –º–æ–≥—É—Ç
};

// –¢–æ–ø–∏–∫: —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω—ã –º–æ–≥—É—Ç –ø–∏—Å–∞—Ç—å
var adminTopic = new ChatRoom {
    Type = ChatRoomType.Topic,
    Name = "Admin Announcements",
    ParentChatRoomId = group.Id,
    AllowMembersToSendMessages = false  // ‚Üê –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫—É —Ä–æ–¥–∏—Ç–µ–ª—è
};

// –ü—Ä–æ–≤–µ—Ä–∫–∞:
var member = await context.ChatRoomMembers.FirstAsync(...);
if (member.Role != ChatRoomRole.Admin) {
    bool canWrite = adminTopic.GetEffectiveAllowMembersToSendMessages();
    // canWrite = false (–±–µ—Ä—ë—Ç—Å—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç–æ–ø–∏–∫–∞, –Ω–µ –≥—Ä—É–ø–ø—ã)
}
```

---

## 5Ô∏è‚É£ –†–∞–±–æ—Ç–∞ —Å–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π

### –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø—Ä–∏ –Ω–æ–≤–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏

```csharp
// –ü–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ MongoDB
await mongoRepo.SendMessageAsync(new MongoMessage {
    ChatId = chatRoomId,
    Sender = new MessageSender { UserId = userId, Username = "john" },
    Content = "Hello!",
    SentAt = DateTime.UtcNow
});

// ‚úÖ –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –≤ SQLite
await context.UpdateChatStatisticsAsync(chatRoomId);

// –¢–µ–ø–µ—Ä—å:
// - TotalMessagesCount —É–≤–µ–ª–∏—á–∏–ª—Å—è –Ω–∞ 1
// - LastActivityAt = DateTime.UtcNow
```

### –ü–æ–ª—É—á–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö —á–∞—Ç–æ–≤

```csharp
// –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –ø–æ—Å–ª–µ–¥–Ω–µ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
var activeChats = await context.ChatRooms
    .Where(cr => cr.Members.Any(m => m.UserId == userId))  // –ú–æ–∏ —á–∞—Ç—ã
    .OrderByDescending(cr => cr.LastActivityAt)             // –°–Ω–∞—á–∞–ª–∞ –∞–∫—Ç–∏–≤–Ω—ã–µ
    .Take(20)
    .ToListAsync();

foreach (var chat in activeChats) {
    var timeSinceActivity = DateTime.UtcNow - (chat.LastActivityAt ?? chat.CreatedAt);
    Console.WriteLine($"{chat.Name}: {chat.TotalMessagesCount} messages, active {timeSinceActivity.TotalHours:F1}h ago");
}
```

---

## 6Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ —Å —É—á—ë—Ç–æ–º –≤—Å–µ—Ö —Ç–∏–ø–æ–≤

### –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –Ω–∞ –æ—Ç–ø—Ä–∞–≤–∫—É

```csharp
public async Task<SendMessageResult> SendMessageAsync(
    int chatRoomId, 
    int userId, 
    string content,
    List<Attachment> attachments)
{
    var chatRoom = await context.ChatRooms
        .Include(cr => cr.ParentChatRoom)
        .FirstAsync(cr => cr.Id == chatRoomId);

    // 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –º–æ–∂–µ—Ç –ª–∏ –ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è
    if (!await context.CanUserSendMessageAsync(chatRoomId, userId)) {
        return new SendMessageResult { 
            Success = false, 
            Error = "You cannot send messages in this chat" 
        };
    }

    // 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∞–≤–∞ –Ω–∞ –º–µ–¥–∏–∞
    if (attachments.Any() && !await context.CanUserSendMediaAsync(chatRoomId, userId)) {
        return new SendMessageResult { 
            Success = false, 
            Error = "You cannot send media in this chat" 
        };
    }

    // 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Slow Mode
    var slowMode = chatRoom.GetEffectiveSlowModeSeconds();
    if (slowMode.HasValue) {
        var lastMessage = await mongoRepo.GetLastUserMessageAsync(chatRoomId, userId);
        if (lastMessage != null) {
            var timeSince = DateTime.UtcNow - lastMessage.SentAt;
            if (timeSince.TotalSeconds < slowMode.Value) {
                var waitTime = slowMode.Value - (int)timeSince.TotalSeconds;
                return new SendMessageResult { 
                    Success = false, 
                    Error = $"Slow mode: wait {waitTime} seconds" 
                };
            }
        }
    }

    // 4. –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
    var message = new MongoMessage {
        ChatId = chatRoomId,
        Sender = new MessageSender { UserId = userId, ... },
        Content = content,
        Attachments = attachments.Select(a => new MessageAttachment { ... }).ToList(),
        SentAt = DateTime.UtcNow
    };
    await mongoRepo.SendMessageAsync(message);

    // 5. –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    await context.UpdateChatStatisticsAsync(chatRoomId);

    return new SendMessageResult { Success = true, MessageId = message.Id };
}
```

---

## 7Ô∏è‚É£ –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —á–∞—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

### –í—Å–µ —á–∞—Ç—ã —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π

```csharp
var userChats = await context.ChatRooms
    .Where(cr => cr.Members.Any(m => m.UserId == userId))
    .Select(cr => new ChatListItem {
        Id = cr.Id,
        Type = cr.Type,
        Name = cr.Type == ChatRoomType.DirectMessage 
            ? null  // –ò–º—è —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ
            : cr.Name,
        AvatarUrl = cr.AvatarUrl,
        TotalMessagesCount = cr.TotalMessagesCount,
        LastActivityAt = cr.LastActivityAt,
        
        // –î–ª—è DirectMessage –ø–æ–ª—É—á–∏—Ç—å –∏–º—è —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞
        OtherUserName = cr.Type == ChatRoomType.DirectMessage
            ? cr.Members.First(m => m.UserId != userId).User.Username
            : null,
        
        // –î–ª—è —Ç–æ–ø–∏–∫–æ–≤ –ø–æ–ª—É—á–∏—Ç—å –∏–º—è —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–π –≥—Ä—É–ø–ø—ã
        ParentGroupName = cr.Type == ChatRoomType.Topic && cr.ParentChatRoom != null
            ? cr.ParentChatRoom.Name
            : null
    })
    .OrderByDescending(c => c.LastActivityAt)
    .ToListAsync();
```

### –¢–æ–ª—å–∫–æ –ª–∏—á–Ω—ã–µ —á–∞—Ç—ã

```csharp
var directChats = await context.ChatRooms
    .Include(cr => cr.Members)
        .ThenInclude(m => m.User)
    .Where(cr => cr.Type == ChatRoomType.DirectMessage)
    .Where(cr => cr.Members.Any(m => m.UserId == userId))
    .ToListAsync();

foreach (var chat in directChats) {
    var otherUser = chat.Members.First(m => m.UserId != userId).User;
    Console.WriteLine($"Chat with {otherUser.Username} ({chat.TotalMessagesCount} messages)");
}
```

### –¢–æ–ª—å–∫–æ –≥—Ä—É–ø–ø—ã –∏ –∫–∞–Ω–∞–ª—ã

```csharp
var groups = await context.ChatRooms
    .Where(cr => cr.Type == ChatRoomType.Private || cr.Type == ChatRoomType.Public || cr.Type == ChatRoomType.Channel)
    .Where(cr => cr.Members.Any(m => m.UserId == userId))
    .Include(cr => cr.Topics)  // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ç–æ–ø–∏–∫–∏
    .ToListAsync();

foreach (var group in groups) {
    Console.WriteLine($"{group.Name} ({group.Type}): {group.Topics.Count} topics");
    foreach (var topic in group.Topics) {
        Console.WriteLine($"  - {topic.Name}");
    }
}
```

---

## üéì –í–´–í–û–î–´

### ‚úÖ –ß—Ç–æ –º—ã —Ä–µ–∞–ª–∏–∑–æ–≤–∞–ª–∏:

1. **–ï–¥–∏–Ω—ã–π –∫–ª–∞—Å—Å ChatRoom** –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ —á–∞—Ç–æ–≤
2. **5 —Ç–∏–ø–æ–≤ —á–∞—Ç–æ–≤**: DirectMessage, Private, Public, Channel, Topic
3. **–ì–∏–±–∫–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏** —Å nullable –ø–æ–ª—è–º–∏ (–∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è defaults)
4. **–ù–∞—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫** –¥–ª—è —Ç–æ–ø–∏–∫–æ–≤ –æ—Ç —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏—Ö –≥—Ä—É–ø–ø
5. **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞** - TotalMessagesCount, LastActivityAt
6. **Extension methods** - –≥–æ—Ç–æ–≤—ã–µ –º–µ—Ç–æ–¥—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤
7. **–í–∞–ª–∏–¥–∞—Ü–∏—è** - —Ä–∞–∑–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤

### üìù –î–ª—è –ª–∏—á–Ω—ã—Ö —á–∞—Ç–æ–≤ (DirectMessage):
- ‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ **–∏–≥–Ω–æ—Ä–∏—Ä—É—é—Ç—Å—è** (–≤—Å–µ–≥–¥–∞ defaults)
- ‚úÖ –í—Å–µ–≥–¥–∞ **—Ä–æ–≤–Ω–æ 2 —É—á–∞—Å—Ç–Ω–∏–∫–∞**
- ‚úÖ –û–±–∞ –º–æ–≥—É—Ç –ø–∏—Å–∞—Ç—å, –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –º–µ–¥–∏–∞
- ‚úÖ –ù–µ—Ç –∞–¥–º–∏–Ω–æ–≤, —Ä–æ–ª–µ–π, –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π

### üìù –î–ª—è –≥—Ä—É–ø–ø/–∫–∞–Ω–∞–ª–æ–≤:
- ‚úÖ –í—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ **—Ä–∞–±–æ—Ç–∞—é—Ç**
- ‚úÖ –ï—Å—Ç—å **—Ä–æ–ª–∏** (Owner, Admin, Member)
- ‚úÖ –ì–∏–±–∫–∏–µ **—Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è**
- ‚úÖ **Slow Mode** –¥–ª—è –∞–Ω—Ç–∏—Å–ø–∞–º–∞

### üìù –î–ª—è —Ç–æ–ø–∏–∫–æ–≤:
- ‚úÖ **–ù–∞—Å–ª–µ–¥—É—é—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤** –æ—Ç —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–π –≥—Ä—É–ø–ø—ã
- ‚úÖ **–ù–∞—Å–ª–µ–¥—É—é—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏** (–µ—Å–ª–∏ –Ω–µ –∑–∞–¥–∞–Ω—ã —Å–≤–æ–∏)
- ‚úÖ –ú–æ–∂–Ω–æ **–ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å** –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
- ‚úÖ **ParentChatRoomId** –¥–ª—è —Å–≤—è–∑–∏

---

## üöÄ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. –°–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é:
   ```bash
   cd Uchat.Database
   dotnet ef migrations add AddChatRoomEnhancements
   dotnet ef database update
   ```

2. –û–±–Ω–æ–≤–∏—Ç—å MongoDB —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏

3. –î–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é –Ω–∞ —É—Ä–æ–≤–Ω–µ API (–∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã)

4. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å Slow Mode –ø—Ä–æ–≤–µ—Ä–∫—É

5. –î–æ–±–∞–≤–∏—Ç—å UI –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –≥—Ä—É–ø–ø
