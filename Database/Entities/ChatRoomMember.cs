/*
 * ============================================================================
 * ENTITY MODEL: CHATROOMME MBER (Участник группового чата)
 * ============================================================================
 * 
 * ЭТО ОЧЕНЬ ВАЖНАЯ КОНЦЕПЦИЯ - ПРОМЕЖУТОЧНАЯ ТАБЛИЦА!
 * 
 * Но что если нам нужно хранить ДОПОЛНИТЕЛЬНЫЕ ДАННЫЕ о связи?
 * - Когда пользователь присоединился к группе?
 * - Какая у него роль (админ, модератор)?
 * - Кто его пригласил?
 * - Заблокирован ли он в этой группе?
 * 
 * Для этого нужна ПОЛНОЦЕННАЯ МОДЕЛЬ, а не просто таблица связей!
 * 
 * Это называется "Association Object Pattern" или "Rich Many-to-Many".
 * 
 * ============================================================================
 * СХЕМА СВЯЗЕЙ:
 * ============================================================================
 * 
 *   User (1) <-----> (Many) ChatRoomMember (Many) <-----> (1) ChatRoom
 * 
 *   Один пользователь может быть в МНОГИХ группах
 *   Одна группа может иметь МНОГИХ участников
 *   ChatRoomMember хранит информацию об этой связи
 * 
 * ============================================================================
 */

namespace Database.Entities;


// Эта таблица соединяет Users и ChatRooms в отношении Many-to-Many
public class ChatRoomMember
{
    // ========================================================================
    // PRIMARY KEY
    // ========================================================================
    public int Id { get; set; }
    
    // ========================================================================
    // FOREIGN KEYS (Связи)
    // ========================================================================

    public int ChatRoomId { get; set; }
    public int UserId { get; set; }
    
    // ========================================================================
    // РОЛЬ В ГРУППЕ
    // ========================================================================

    /// Member = 0 (обычный участник)
    /// Admin = 1 (может менять настройки группы, назначать модераторов)
    /// Owner = 2 (создатель, полный контроль, не может быть кикнут)
    public ChatRoomRole Role { get; set; }
    
    // ========================================================================
    // ВРЕМЕННЫЕ МЕТКИ
    // ========================================================================
    
    /// Когда пользователь присоединился к группе
    /// В БД: DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP
    /// 
    /// Полезно для:
    /// - Сортировки участников (кто раньше вступил)
    /// - Статистики (сколько человек присоединилось за месяц)
    public DateTime JoinedAt { get; set; }

    // ========================================================================
    // ПРИГЛАШЕНИЕ
    // ========================================================================

    /// ID пользователя, который пригласил этого участника в группу
    /// 
    /// NULL = присоединился сам (публичная группа) или создатель группы
    /// 
    /// Полезно для:
    /// - Истории: кто кого пригласил (граф приглашений)
    /// - Ответственность: если пригласил спамера, можно понять кто виноват
    public int? InvitedById { get; set; }
    
    // ========================================================================
    // МОДЕРАЦИЯ
    // ========================================================================

    /// Заблокирован ли участник в этой группе (mute/ban)
    /// 
    /// true = не может писать сообщения в группе
    /// false = может писать
    public bool IsMuted { get; set; }
    
    /// <summary>
    /// Mute expiration time. NULL = permanent or not muted
    /// </summary>
    public DateTime? MutedUntil { get; set; }
    
    // ========================================================================
    // NAVIGATION PROPERTIES
    // ========================================================================
    
    public ChatRoom ChatRoom { get; set; } = null!;
    public User User { get; set; } = null!;
    public User? InvitedBy { get; set; }
    
    /// <summary>
    /// Admin permissions (only for Admin and Owner roles)
    /// NULL for regular members
    /// </summary>
    public ChatRoomMemberPermissions? Permissions { get; set; }
}

public enum ChatRoomRole
{
    Member = 0,
    Admin = 1,
    Owner = 2
}