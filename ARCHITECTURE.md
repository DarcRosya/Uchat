# Uchat - –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏ –†–µ–∞–ª–∏–∑–∞—Ü–∏—è

## üìã –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ
1. [–û–±–∑–æ—Ä —Å–∏—Å—Ç–µ–º—ã](#–æ–±–∑–æ—Ä-—Å–∏—Å—Ç–µ–º—ã)
2. [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è](#–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ-—Ä–µ—à–µ–Ω–∏—è)
3. [–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫](#—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π-—Å—Ç–µ–∫)
4. [–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö](#—Å—Ç—Ä—É–∫—Ç—É—Ä–∞-–±–∞–∑—ã-–¥–∞–Ω–Ω—ã—Ö)
5. [–°–∏—Å—Ç–µ–º–∞ —Å–æ–æ–±—â–µ–Ω–∏–π](#—Å–∏—Å—Ç–µ–º–∞-—Å–æ–æ–±—â–µ–Ω–∏–π)
6. [–ü–∞–≥–∏–Ω–∞—Ü–∏—è –∏ –∏—Å—Ç–æ—Ä–∏—è](#–ø–∞–≥–∏–Ω–∞—Ü–∏—è-–∏-–∏—Å—Ç–æ—Ä–∏—è)
7. [–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ —á–∞—Ç—ã](#–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ-–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ-–≤-—á–∞—Ç—ã)
8. [–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∂–¥—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç](#–∫–∞–∫-—Ä–∞–±–æ—Ç–∞–µ—Ç-–∫–∞–∂–¥—ã–π-–∫–æ–º–ø–æ–Ω–µ–Ω—Ç)

---

## üéØ –û–±–∑–æ—Ä —Å–∏—Å—Ç–µ–º—ã

**Uchat** - —ç—Ç–æ real-time –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä –Ω–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ **REST API + SignalR**, —Å —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ–º –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏:
- **REST API** - –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ CRUD (—Å–æ–∑–¥–∞–Ω–∏–µ, —á—Ç–µ–Ω–∏–µ, —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ, —É–¥–∞–ª–µ–Ω–∏–µ)
- **SignalR** - —Ç–æ–ª—å–∫–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ (—Å–æ–±—ã—Ç–∏—è)

### –ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:
‚úÖ Hybrid Architecture (REST + SignalR)  
‚úÖ Cursor-based pagination –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π  
‚úÖ Auto-join –≤ –≥—Ä—É–ø–ø—ã SignalR –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏  
‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö —á–∞—Ç–æ–≤  
‚úÖ MongoDB –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π + PostgreSQL –¥–ª—è –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö  
‚úÖ JWT Bearer Authentication  

---

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è

### 1. **–†–∞–∑–¥–µ–ª–µ–Ω–∏–µ REST API –∏ SignalR**

**–ü—Ä–æ–±–ª–µ–º–∞:** –ò–∑–Ω–∞—á–∞–ª—å–Ω–æ –≤–µ—Å—å CRUD –±—ã–ª —á–µ—Ä–µ–∑ SignalR (SendMessage, DeleteMessage, EditMessage)  
**–†–µ—à–µ–Ω–∏–µ:** –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ –≥–∏–±—Ä–∏–¥–Ω—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É

#### –î–æ (—Ç–æ–ª—å–∫–æ SignalR):
```csharp
// –ö–ª–∏–µ–Ω—Ç
await _hubConnection.InvokeAsync("SendMessage", chatId, content);
await _hubConnection.InvokeAsync("DeleteMessage", messageId);

// –°–µ—Ä–≤–µ—Ä
public async Task SendMessage(int chatId, string content) { ... }
public async Task DeleteMessage(string messageId) { ... }
```

#### –ü–æ—Å–ª–µ (REST + SignalR):
```csharp
// –ö–ª–∏–µ–Ω—Ç - CRUD —á–µ—Ä–µ–∑ REST API
await _messageApiService.SendMessageAsync(chatId, dto);
await _messageApiService.DeleteMessageAsync(chatId, messageId);

// –°–µ—Ä–≤–µ—Ä - REST –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –≤—ã–ø–æ–ª–Ω—è–µ—Ç –¥–µ–π—Å—Ç–≤–∏–µ + —à–ª–µ—Ç SignalR —Å–æ–±—ã—Ç–∏–µ
[HttpPost("api/chats/{chatId}/messages")]
public async Task<IActionResult> SendMessage(int chatId, MessageCreateDto dto)
{
    var message = await _messageService.CreateMessageAsync(dto);
    
    // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ SignalR
    await _hubContext.Clients
        .Group($"chat_{chatId}")
        .SendAsync("ReceiveMessage", message);
    
    return Ok(message);
}
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ RESTful —Å—Ç–∞–Ω–¥–∞—Ä—Ç (–º–æ–∂–Ω–æ –ª–µ–≥–∫–æ –¥–æ–±–∞–≤–∏—Ç—å –º–æ–±–∏–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ)
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ (HTTP —Å—Ç–∞—Ç—É—Å –∫–æ–¥—ã)
- ‚úÖ SignalR —Ç–æ–ª—å–∫–æ –¥–ª—è —Å–æ–±—ã—Ç–∏–π (–ª–µ–≥—á–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∏ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞—Ç—å)
- ‚úÖ –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ Redis Pub/Sub –º–∏–≥—Ä–∞—Ü–∏–∏

---

### 2. **Auto-Join –≤ SignalR –≥—Ä—É–ø–ø—ã**

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–∏ –∫–∞–∂–¥–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏ –Ω—É–∂–Ω–æ –±—ã–ª–æ –≤—Ä—É—á–Ω—É—é –ø—Ä–∏—Å–æ–µ–¥–∏–Ω—è—Ç—å—Å—è –∫ –≥—Ä—É–ø–ø–µ  
**–†–µ—à–µ–Ω–∏–µ:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –í–°–ï –≥—Ä—É–ø–ø—ã —á–∞—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏

#### ChatHub.cs - OnConnectedAsync
```csharp
public override async Task OnConnectedAsync()
{
    var userId = int.Parse(Context.User!.FindFirst(ClaimTypes.NameIdentifier)!.Value);
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –í–°–ï —á–∞—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –±–∞–∑—ã
    var userChats = await _chatRoomRepository.GetUserChatRoomsAsync(userId);
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω—è–µ–º—Å—è –∫–æ –≤—Å–µ–º –≥—Ä—É–ø–ø–∞–º
    foreach (var chat in userChats)
    {
        await Groups.AddToGroupAsync(Context.ConnectionId, $"chat_{chat.Id}");
    }
    
    Console.WriteLine($"[Auto-Join] User {userId} joined {userChats.Count()} chat groups");
    
    await base.OnConnectedAsync();
}
```

**–ó–∞—á–µ–º —ç—Ç–æ –Ω—É–∂–Ω–æ:**
- ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∏–∑ –í–°–ï–• —Å–≤–æ–∏—Ö —á–∞—Ç–æ–≤ —Å—Ä–∞–∑—É
- ‚úÖ –ù–µ –Ω—É–∂–Ω–æ –≤—Ä—É—á–Ω—É—é –≤—ã–∑—ã–≤–∞—Ç—å `JoinGroup` –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –∫–∞–∂–¥–æ–≥–æ —á–∞—Ç–∞
- ‚úÖ –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ Redis Pub/Sub (–∑–∞–º–µ–Ω–∞ SignalR Groups –Ω–∞ Redis –∫–∞–Ω–∞–ª—ã)

**–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –≤ –∫–æ–¥–µ:**
```csharp
// –ü–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ Redis: —ç—Ç–æ –±—É–¥–µ—Ç –∑–∞–º–µ–Ω–µ–Ω–æ –Ω–∞ Redis Pub/Sub –ø–æ–¥–ø–∏—Å–∫–∏
// –í–º–µ—Å—Ç–æ Groups.AddToGroupAsync –±—É–¥–µ—Ç SUBSCRIBE –∫ –∫–∞–Ω–∞–ª—É "chat_{chatId}"
```

---

### 3. **Cursor-based Pagination (–ö—É—Ä—Å–æ—Ä–Ω–∞—è –ø–∞–≥–∏–Ω–∞—Ü–∏—è)**

**–ü—Ä–æ–±–ª–µ–º–∞:** Offset-based –ø–∞–≥–∏–Ω–∞—Ü–∏—è (`skip/take`) –Ω–µ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–∞ –¥–ª—è –±–æ–ª—å—à–∏—Ö –æ–±—ä–µ–º–æ–≤  
**–†–µ—à–µ–Ω–∏–µ:** –ü–∞–≥–∏–Ω–∞—Ü–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫—É—Ä—Å–æ—Ä–∞ (DateTime –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è)

#### –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:

1. **–ù–∞—á–∞–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞** (50 –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π):
```csharp
GET /api/chats/1/messages?limit=50
```

2. **–ü–æ–¥–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏** (30 —Å–æ–æ–±—â–µ–Ω–∏–π –î–û –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–π –¥–∞—Ç—ã):
```csharp
GET /api/chats/1/messages?limit=30&before=2025-12-04T10:30:00Z
```

#### MessageApiService.cs
```csharp
public async Task<PaginatedMessagesDto> GetMessagesAsync(
    int chatId, 
    int limit = 50, 
    DateTime? before = null)
{
    var url = $"/api/chats/{chatId}/messages?limit={limit}";
    
    if (before.HasValue)
    {
        url += $"&before={before.Value:O}"; // ISO 8601 format
    }
    
    return await _httpClient.GetFromJsonAsync<PaginatedMessagesDto>(url);
}
```

#### MongoDB Query (MessageRepository.cs)
```csharp
public async Task<List<MongoMessage>> GetMessagesAsync(
    int chatRoomId, 
    int limit = 50, 
    DateTime? before = null)
{
    var filter = Builders<MongoMessage>.Filter.Eq(m => m.ChatRoomId, chatRoomId);
    
    // –ï—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω –∫—É—Ä—Å–æ—Ä - –±–µ—Ä–µ–º —Ç–æ–ª—å–∫–æ —Å–æ–æ–±—â–µ–Ω–∏—è –°–¢–ê–†–®–ï —ç—Ç–æ–π –¥–∞—Ç—ã
    if (before.HasValue)
    {
        filter &= Builders<MongoMessage>.Filter.Lt(m => m.SentAt, before.Value);
    }
    
    return await _messages
        .Find(filter)
        .SortByDescending(m => m.SentAt) // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –¥–∞—Ç–µ (–Ω–æ–≤—ã–µ –ø–µ—Ä–≤—ã–µ)
        .Limit(limit)
        .ToListAsync();
}
```

**–°–æ—Å—Ç–æ—è–Ω–∏–µ –≤ –∫–ª–∏–µ–Ω—Ç–µ:**
```csharp
private DateTime? _oldestMessageDate = null; // –ö—É—Ä—Å–æ—Ä - —Å–∞–º–æ–µ —Å—Ç–∞—Ä–æ–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
private bool _hasMoreMessages = true; // –ï—Å—Ç—å –ª–∏ –µ—â–µ —Å–æ–æ–±—â–µ–Ω–∏—è?
private bool _isLoadingHistory = false; // –§–ª–∞–≥ –∑–∞–≥—Ä—É–∑–∫–∏ (–ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –¥–≤–æ–π–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã)
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: MongoDB –∏–Ω–¥–µ–∫—Å –ø–æ `SentAt` + `ChatRoomId`
- ‚úÖ –°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å: –Ω–µ—Ç –ø—Ä–æ–±–ª–µ–º —Å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ–º –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
- ‚úÖ –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å: —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –º–∏–ª–ª–∏–æ–Ω–∞–º–∏ —Å–æ–æ–±—â–µ–Ω–∏–π

---

### 4. **Smooth Scroll Position (–ü–ª–∞–≤–Ω–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –ø—Ä–∏ –ø–æ–¥–≥—Ä—É–∑–∫–µ)**

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–∏ –≤—Å—Ç–∞–≤–∫–µ —Å—Ç–∞—Ä—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –≤–≤–µ—Ä—Ö —Å–ø–∏—Å–∫–∞ - —Å–∫—Ä–æ–ª–ª "—Ç–µ–ª–µ–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è" –∏ –¥–µ—Ä–≥–∞–µ—Ç—Å—è

#### –†–µ—à–µ–Ω–∏–µ: `RunJobs(DispatcherPriority.Layout)` - —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –ø–µ—Ä–µ—Å—á–µ—Ç –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç

```csharp
private async Task LoadMoreHistoryAsync()
{
    _isLoadingHistory = true;
    
    var result = await _messageApiService.GetMessagesAsync(
        _currentChatId.Value, 
        limit: 30, 
        before: _oldestMessageDate.Value
    );
    
    await Dispatcher.UIThread.InvokeAsync(() =>
    {
        // 1. –ó–ê–ü–û–ú–ò–ù–ê–ï–ú "–Ø–ö–û–†–¨" - –ø–µ—Ä–≤–æ–µ –≤–∏–¥–∏–º–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        var anchorItem = ChatMessagesPanel.Children.FirstOrDefault() as Control;
        
        var messages = result.Messages;
        messages.Reverse();
        
        _hasMoreMessages = result.Pagination.HasMore;
        _oldestMessageDate = messages[0].SentAt;
        
        // 2. –í–°–¢–ê–í–õ–Ø–ï–ú –ù–û–í–´–ï –°–û–û–ë–©–ï–ù–ò–Ø –í –ù–ê–ß–ê–õ–û
        for (int i = messages.Count - 1; i >= 0; i--)
        {
            var grid = CreateMessageGrid(messages[i]);
            ChatMessagesPanel.Children.Insert(0, grid);
        }
        
        // 3. –ú–ê–ì–ò–Ø: –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π –ø–µ—Ä–µ—Å—á–µ—Ç Layout –ü–†–Ø–ú–û –°–ï–ô–ß–ê–°
        // –≠—Ç–æ –æ–±–Ω–æ–≤–ª—è–µ—Ç –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã anchorItem.Bounds.Y —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ
        Dispatcher.UIThread.RunJobs(DispatcherPriority.Layout);
        
        // 4. –ö–û–†–†–ï–ö–¶–ò–Ø –°–ö–†–û–õ–õ–ê
        // anchorItem —Ç–µ–ø–µ—Ä—å —Å–¥–≤–∏–Ω—É–ª—Å—è –≤–Ω–∏–∑ –Ω–∞ –≤—ã—Å–æ—Ç—É –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
        // –ï–≥–æ –Ω–æ–≤—ã–π Y - —ç—Ç–æ –∏–º–µ–Ω–Ω–æ —Ç–æ—Ç offset, –∫–æ—Ç–æ—Ä—ã–π –Ω–∞–º –Ω—É–∂–µ–Ω
        if (anchorItem != null)
        {
            ChatScrollViewer.Offset = new Vector(0, anchorItem.Bounds.Y);
        }
    });
    
    await Task.Delay(200); // Debounce
    _isLoadingHistory = false;
}
```

**–ü–æ—á–µ–º—É —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:**

1. –î–æ –≤—Å—Ç–∞–≤–∫–∏: `anchorItem.Bounds.Y = 0` (–ø–µ—Ä–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç –≤–≤–µ—Ä—Ö—É)
2. –í—Å—Ç–∞–≤–∏–ª–∏ 30 —Å–æ–æ–±—â–µ–Ω–∏–π (–≤—ã—Å–æ—Ç–∞ = 1500px)
3. `RunJobs(Layout)` - Avalonia –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã **–°–ò–ù–•–†–û–ù–ù–û**
4. –¢–µ–ø–µ—Ä—å: `anchorItem.Bounds.Y = 1500` (—Å–¥–≤–∏–Ω—É–ª—Å—è –≤–Ω–∏–∑)
5. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º `ScrollViewer.Offset = 1500`
6. **–¢–û–õ–¨–ö–û –ü–û–°–õ–ï** —ç—Ç–æ–≥–æ Avalonia –æ—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ—Ç –∫–∞–¥—Ä
7. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç: —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–∞ —Ç–æ–º –∂–µ –º–µ—Å—Ç–µ (–ø–ª–∞–≤–Ω–æ)

**–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã –∫–æ—Ç–æ—Ä—ã–µ –ù–ï —Ä–∞–±–æ—Ç–∞—é—Ç:**
- ‚ùå `DispatcherPriority.Background` - —Å–ª–∏—à–∫–æ–º –ø–æ–∑–¥–Ω–æ, –∫–∞–¥—Ä —É–∂–µ –æ—Ç—Ä–∏—Å–æ–≤–∞–Ω
- ‚ùå `DispatcherPriority.Render` - —Ç–æ–∂–µ –ø–æ–∑–¥–Ω–æ
- ‚ùå `Extent.Height` —Ä–∞–∑–Ω–∏—Ü–∞ - –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω–∞ –≤ Avalonia —Å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–º –∫–æ–Ω—Ç–µ–Ω—Ç–æ–º
- ‚ùå `Dispatcher.Post(() => ...)` - –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ, –≤–∏–¥–µ–Ω –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–π –∫–∞–¥—Ä

---

### 5. **Scroll Event Handler (–¢—Ä–∏–≥–≥–µ—Ä –ø–æ–¥–≥—Ä—É–∑–∫–∏)**

```csharp
public void OnChatScrollChanged(object? sender, ScrollChangedEventArgs e)
{
    // –°—Ç—Ä–æ–≥–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏
    if (_isLoadingHistory || !_hasMoreMessages) return;
    
    var scrollViewer = sender as ScrollViewer;
    if (scrollViewer == null) return;
    
    // –ó–∞—â–∏—Ç–∞ –æ—Ç –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ–≥–æ —Ü–∏–∫–ª–∞ (–µ—Å–ª–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –º–µ–Ω—å—à–µ —ç–∫—Ä–∞–Ω–∞)
    if (scrollViewer.Extent.Height <= scrollViewer.Viewport.Height) return;
    
    // –¢—Ä–∏–≥–≥–µ—Ä: –µ—Å–ª–∏ –¥–æ –≤–µ—Ä—Ö–∞ –º–µ–Ω—å—à–µ 50 –ø–∏–∫—Å–µ–ª–µ–π
    if (scrollViewer.Offset.Y < 50)
    {
        _ = LoadMoreHistoryAsync();
    }
}
```

**MainWindow.axaml:**
```xml
<ScrollViewer Name="ChatScrollViewer" 
              ScrollChanged="OnChatScrollChanged">
    <StackPanel Name="ChatMessagesPanel" />
</ScrollViewer>
```

---

## üóÑÔ∏è –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

### PostgreSQL (–ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ)

**Users** - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
```sql
Id (PK), Username, Email, PasswordHash, DisplayName, CreatedAt, Role
```

**ChatRooms** - –ö–æ–º–Ω–∞—Ç—ã —á–∞—Ç–æ–≤
```sql
Id (PK), Name, Description, Type (DirectMessage/Public/Private), 
CreatorId (FK ‚Üí Users), CreatedAt, MaxMembers
```

**ChatRoomMembers** - –°–≤—è–∑—å Many-to-Many
```sql
Id (PK), ChatRoomId (FK ‚Üí ChatRooms), UserId (FK ‚Üí Users), JoinedAt
```

**RefreshTokens** - JWT —Ç–æ–∫–µ–Ω—ã
```sql
Id (PK), UserId (FK ‚Üí Users), TokenHash, ExpiresAt, CreatedAt
```

### MongoDB (–°–æ–æ–±—â–µ–Ω–∏—è)

**Collection: messages**
```javascript
{
  "_id": "ObjectId",
  "ChatRoomId": 1,
  "SenderId": 5,
  "Content": "Hello!",
  "Type": "text",
  "SentAt": "2025-12-04T10:30:00Z",
  "EditedAt": null,
  "IsDeleted": false,
  "ReplyToMessageId": "67502..."
}
```

**–ò–Ω–¥–µ–∫—Å—ã:**
```javascript
{ ChatRoomId: 1, SentAt: -1 } // –î–ª—è –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
{ _id: 1 } // Primary key
```

---

## üîß –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ —á–∞—Ç—ã

### –ü—Ä–æ–±–ª–µ–º–∞ —Å—Ç–∞—Ä–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞:

```csharp
// ‚ùå –ü–õ–û–•–û: Race condition + —Ö–∞—Ä–¥–∫–æ–¥ ID
private const int GLOBAL_PUBLIC_CHAT_ID = 1;

private async Task AddUserToGlobalPublicChat(int userId)
{
    var globalChat = await _chatRoomRepository.GetByIdAsync(GLOBAL_PUBLIC_CHAT_ID);
    
    if (globalChat == null)
    {
        // –°–æ–∑–¥–∞–µ–º —á–∞—Ç –ø—Ä—è–º–æ –∑–¥–µ—Å—å (–µ—Å–ª–∏ –¥–≤–∞ —é–∑–µ—Ä–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É—é—Ç—Å—è –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ = –¥—É–±–ª–∏)
        globalChat = await _chatRoomService.CreateChatAsync(...);
    }
    
    await _chatRoomRepository.AddMemberAsync(new ChatRoomMember { ... });
}
```

**–ü—Ä–æ–±–ª–µ–º—ã:**
1. **Race Condition:** –î–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É—é—Ç—Å—è –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ ‚Üí –¥–≤–∞ –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö —á–∞—Ç–∞
2. **Hardcoded ID:** –ï—Å–ª–∏ –±–∞–∑–∞ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–µ—Ç—Å—è, ID –º–æ–∂–µ—Ç —Å—Ç–∞—Ç—å 5, 10, 100
3. **–°–º–µ—à–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏:** –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–µ –¥–æ–ª–∂–Ω–∞ —Å–æ–∑–¥–∞–≤–∞—Ç—å –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É

---

### –†–µ—à–µ–Ω–∏–µ: Database Seeding (DbInitializer)

#### 1. DbInitializer.cs - —Å–æ–∑–¥–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö —Å—É—â–Ω–æ—Å—Ç–µ–π
```csharp
public static class DbInitializer
{
    public static async Task InitializeAsync(UchatDbContext context)
    {
        // 1. –°–æ–∑–¥–∞–µ–º —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–≤–ª–∞–¥–µ–ª–µ—Ü –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö —á–∞—Ç–æ–≤)
        var systemUser = await context.Users
            .FirstOrDefaultAsync(u => u.Username == "System");
            
        if (systemUser == null)
        {
            systemUser = new User 
            { 
                Username = "System", 
                Email = "system@uchat.com",
                DisplayName = "System Bot",
                PasswordHash = BCrypt.Net.BCrypt.HashPassword("SYSTEM_NO_LOGIN_" + Guid.NewGuid()),
                Role = UserRole.Admin
            };
            context.Users.Add(systemUser);
            await context.SaveChangesAsync();
            
            Console.WriteLine($"[DbInitializer] Created system user (ID: {systemUser.Id})");
        }
        
        // 2. –°–æ–∑–¥–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π —á–∞—Ç (–ò–©–ï–ú –ü–û –ò–ú–ï–ù–ò, –ù–ï –ü–û ID)
        var globalChat = await context.ChatRooms
            .FirstOrDefaultAsync(c => c.Name == "Global Chat");
            
        if (globalChat == null)
        {
            globalChat = new ChatRoom
            {
                Name = "Global Chat",
                Description = "Official public chat for all users",
                Type = ChatRoomType.Public,
                CreatorId = systemUser.Id,
                MaxMembers = 1000000
            };
            context.ChatRooms.Add(globalChat);
            await context.SaveChangesAsync();
            
            // –î–æ–±–∞–≤–ª—è–µ–º System –±–æ—Ç–∞ –∫–∞–∫ —É—á–∞—Å—Ç–Ω–∏–∫–∞
            context.ChatRoomMembers.Add(new ChatRoomMember
            {
                ChatRoomId = globalChat.Id,
                UserId = systemUser.Id,
                JoinedAt = DateTime.UtcNow
            });
            await context.SaveChangesAsync();
            
            Console.WriteLine($"[DbInitializer] Created Global Chat (ID: {globalChat.Id})");
        }
    }
}
```

#### 2. Program.cs - –∑–∞–ø—É—Å–∫ seeding –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
```csharp
public static async Task Main(string[] args) // –í–ê–ñ–ù–û: async Task
{
    var app = builder.Build();
    
    using (var scope = app.Services.CreateScope())
    {
        var dbContext = scope.ServiceProvider.GetRequiredService<UchatDbContext>();
        
        // –ü—Ä–∏–º–µ–Ω—è–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏
        dbContext.Database.Migrate();
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        await DbInitializer.InitializeAsync(dbContext);
    }
    
    app.Run();
}
```

#### 3. AuthService - —É–ø—Ä–æ—â–µ–Ω–Ω–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
```csharp
public async Task<AuthResponseDto> RegisterAsync(RegisterDto dto)
{
    var user = await _userRepository.CreateUserAsync(dto.Username, passwordHash, dto.Email);
    
    // –°–æ–∑–¥–∞–µ–º –ª–∏—á–Ω—ã–π —á–∞—Ç "Notes"
    await CreatePersonalNotesChat(user.Id, user.Username);
    
    // –î–æ–±–∞–≤–ª—è–µ–º –≤ –≥–ª–æ–±–∞–ª—å–Ω—ã–π —á–∞—Ç (–∫–æ—Ç–æ—Ä—ã–π –£–ñ–ï –°–£–©–ï–°–¢–í–£–ï–¢)
    await AddUserToGlobalPublicChat(user.Id, user.Username);
    
    return new AuthResponseDto { ... };
}

private async Task AddUserToGlobalPublicChat(int userId, string username)
{
    // –ò—â–µ–º –ø–æ –ò–ú–ï–ù–ò (–Ω–µ –ø–æ ID!)
    var globalChat = await _chatRoomRepository.GetByNameAsync("Global Chat");
    
    if (globalChat == null)
    {
        Console.WriteLine($"[CRITICAL] Global Chat not found!");
        return; // –≠—Ç–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞
    }
    
    // –ü—Ä–æ—Å—Ç–æ –¥–æ–±–∞–≤–ª—è–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–∞
    await _chatRoomRepository.AddMemberAsync(new ChatRoomMember
    {
        ChatRoomId = globalChat.Id,
        UserId = userId,
        JoinedAt = DateTime.UtcNow
    });
    
    Console.WriteLine($"[AuthService] User {username} added to Global Chat (ID: {globalChat.Id})");
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –ì–ª–æ–±–∞–ª—å–Ω—ã–π —á–∞—Ç —Å–æ–∑–¥–∞–µ—Ç—Å—è **1 —Ä–∞–∑** –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ —Å–µ—Ä–≤–µ—Ä–∞
- ‚úÖ –ù–µ—Ç race condition (—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –≤ Main)
- ‚úÖ –ù–µ—Ç —Ö–∞—Ä–¥–∫–æ–¥–∞ ID (–ø–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏)
- ‚úÖ –°–∏—Å—Ç–µ–º–∞ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–∞ (–º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –±–æ–ª—å—à–µ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö —á–∞—Ç–æ–≤)

---

## üì° SignalR –°–æ–±—ã—Ç–∏—è

### –ö–ª–∏–µ–Ω—Ç –ø–æ–¥–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –Ω–∞ —Å–æ–±—ã—Ç–∏—è:

```csharp
// ClientConnections.cs - RegisterSignalRHandlers()

_hubConnection.On<MessageDto>("ReceiveMessage", (message) =>
{
    DisplayMessage(message);
    ChatScrollViewer.ScrollToEnd();
});

_hubConnection.On<string, string, DateTime>("MessageEdited", (messageId, newContent, editedAt) =>
{
    if (_messageCache.TryGetValue(messageId, out var cachedMsg))
    {
        cachedMsg.ContentTextBlock.Text = newContent;
        AddEditedLabel(cachedMsg);
    }
});

_hubConnection.On<string>("MessageDeleted", (messageId) =>
{
    if (_messageCache.TryGetValue(messageId, out var cachedMsg))
    {
        RemoveMessageFromUI(cachedMsg);
        _messageCache.Remove(messageId);
    }
    
    CleanupReplyReferences(messageId);
});

_hubConnection.On<List<string>>("RepliesCleared", (messageIds) =>
{
    foreach (var msgId in messageIds)
    {
        if (_messageCache.TryGetValue(msgId, out var cachedMsg))
        {
            RemoveReplyUI(cachedMsg);
        }
    }
});
```

### –°–µ—Ä–≤–µ—Ä –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–±—ã—Ç–∏—è:

```csharp
// MessagesController.cs

[HttpPost("api/chats/{chatId}/messages")]
public async Task<IActionResult> SendMessage(int chatId, MessageCreateDto dto)
{
    var message = await _messageService.CreateMessageAsync(dto);
    
    await _hubContext.Clients
        .Group($"chat_{chatId}")
        .SendAsync("ReceiveMessage", message);
    
    return Ok(message);
}

[HttpDelete("api/chats/{chatId}/messages/{messageId}")]
public async Task<IActionResult> DeleteMessage(int chatId, string messageId)
{
    var clearedReplyIds = await _messageService.DeleteMessageAsync(messageId);
    
    await _hubContext.Clients
        .Group($"chat_{chatId}")
        .SendAsync("MessageDeleted", messageId);
    
    if (clearedReplyIds.Count > 0)
    {
        await _hubContext.Clients
            .Group($"chat_{chatId}")
            .SendAsync("RepliesCleared", clearedReplyIds);
    }
    
    return NoContent();
}
```

---

## üîê –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è

### JWT Bearer

**–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è:**
```
POST /api/auth/register
{
  "username": "john",
  "password": "pass123",
  "email": "john@example.com"
}

‚Üí Response:
{
  "accessToken": "eyJhbGciOiJIUzI1NiIs...",
  "refreshToken": "d4f5e6g7h8...",
  "userId": 5,
  "username": "john"
}
```

**SignalR –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ:**
```csharp
var token = UserSession.Instance.AccessToken;

_hubConnection = new HubConnectionBuilder()
    .WithUrl($"{ServerConfig.ServerUrl}/chatHub?access_token={token}", options =>
    {
        options.AccessTokenProvider = () => Task.FromResult<string?>(token);
    })
    .Build();
```

---

## üì¶ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
Uchat/
‚îú‚îÄ‚îÄ Database/                    # EF Core + MongoDB
‚îÇ   ‚îú‚îÄ‚îÄ Context/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ UchatDbContext.cs   # PostgreSQL DbContext
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ UchatDbContextFactory.cs
‚îÇ   ‚îú‚îÄ‚îÄ MongoDB/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ MongoDbContext.cs   # MongoDB –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ MongoMessage.cs     # –ú–æ–¥–µ–ª—å —Å–æ–æ–±—â–µ–Ω–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ Entities/               # EF Core —Å—É—â–Ω–æ—Å—Ç–∏
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ User.cs
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ChatRoom.cs
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ChatRoomMember.cs
‚îÇ   ‚îî‚îÄ‚îÄ Repositories/
‚îÇ       ‚îú‚îÄ‚îÄ Interfaces/
‚îÇ       ‚îî‚îÄ‚îÄ Implementations/
‚îÇ
‚îú‚îÄ‚îÄ Uchat.Server/               # ASP.NET Core Backend
‚îÇ   ‚îú‚îÄ‚îÄ Controllers/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AuthController.cs  # POST /api/auth/register, /login
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ChatsController.cs # GET /api/chats
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ MessagesController.cs # CRUD /api/chats/{id}/messages
‚îÇ   ‚îú‚îÄ‚îÄ Hubs/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ChatHub.cs         # SignalR Hub (auto-join groups)
‚îÇ   ‚îú‚îÄ‚îÄ Services/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Auth/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AuthService.cs
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ JwtService.cs
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Chat/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ChatRoomService.cs
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Messaging/
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ MessageService.cs
‚îÇ   ‚îú‚îÄ‚îÄ Data/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ DbInitializer.cs   # Database seeding
‚îÇ   ‚îî‚îÄ‚îÄ Program.cs             # Startup + DI
‚îÇ
‚îî‚îÄ‚îÄ Uchat/                      # Avalonia Desktop Client
    ‚îú‚îÄ‚îÄ Services/
    ‚îÇ   ‚îú‚îÄ‚îÄ AuthApiService.cs  # REST API –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
    ‚îÇ   ‚îú‚îÄ‚îÄ ChatApiService.cs  # REST API –¥–ª—è —á–∞—Ç–æ–≤
    ‚îÇ   ‚îî‚îÄ‚îÄ MessageApiService.cs # REST API –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π
    ‚îú‚îÄ‚îÄ ClientConnections.cs   # SignalR –∫–ª–∏–µ–Ω—Ç + –ø–∞–≥–∏–Ω–∞—Ü–∏—è
    ‚îú‚îÄ‚îÄ MainWindow.axaml       # UI —Ä–∞–∑–º–µ—Ç–∫–∞
    ‚îî‚îÄ‚îÄ Chat/
        ‚îú‚îÄ‚îÄ Message.cs         # UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
        ‚îî‚îÄ‚îÄ MessageContextMenu.cs # –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é
```

---

## üöÄ –ö–∞–∫ –≤—Å–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤–º–µ—Å—Ç–µ

### 1. –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞:
```bash
cd Uchat.Server
dotnet run
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
1. PostgreSQL –º–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è (`dbContext.Database.Migrate()`)
2. `DbInitializer.InitializeAsync()` —Å–æ–∑–¥–∞–µ—Ç System User + Global Chat
3. MongoDB –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è
4. SignalR Hub –≥–æ—Ç–æ–≤ –∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è–º

### 2. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
```
Client ‚Üí POST /api/auth/register
Server:
  1. –°–æ–∑–¥–∞–µ—Ç User –≤ PostgreSQL
  2. –°–æ–∑–¥–∞–µ—Ç –ª–∏—á–Ω—ã–π —á–∞—Ç "Notes" (ChatRoomService)
  3. –î–æ–±–∞–≤–ª—è–µ—Ç –≤ "Global Chat" (GetByNameAsync ‚Üí AddMemberAsync)
  4. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç JWT —Ç–æ–∫–µ–Ω—ã
Client ‚Üê 200 OK { accessToken, refreshToken, userId }
```

### 3. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ SignalR:
```
Client ‚Üí WebSocket /chatHub?access_token=...
Server (OnConnectedAsync):
  1. –ò–∑–≤–ª–µ–∫–∞–µ—Ç userId –∏–∑ JWT
  2. –ó–∞–≥—Ä—É–∂–∞–µ—Ç –≤—Å–µ —á–∞—Ç—ã: GetUserChatRoomsAsync(userId)
  3. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω—è–µ—Ç –∫–æ –≤—Å–µ–º –≥—Ä—É–ø–ø–∞–º:
     Groups.AddToGroupAsync(connectionId, "chat_1")
     Groups.AddToGroupAsync(connectionId, "chat_5")
     Groups.AddToGroupAsync(connectionId, "chat_12")
Client ‚Üê Connected
```

### 4. –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞:
```
Client ‚Üí GET /api/chats/1/messages?limit=50
Server:
  1. MongoDB: Find({ ChatRoomId: 1 }).Sort({ SentAt: -1 }).Limit(50)
  2. Batch load reply references (GetMessagesByIdsAsync)
Client ‚Üê 200 OK { 
  Messages: [...], 
  Pagination: { HasMore: true } 
}

Client:
  - –°–æ—Ö—Ä–∞–Ω—è–µ—Ç _oldestMessageDate = messages[0].SentAt
  - –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
  - ScrollToEnd()
```

### 5. –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è:
```
Client ‚Üí POST /api/chats/1/messages { Content: "Hello!" }
Server (MessagesController):
  1. MongoDB.InsertOneAsync(message)
  2. SignalR broadcast:
     Clients.Group("chat_1").SendAsync("ReceiveMessage", messageDto)
Client (–≤—Å–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã–µ) ‚Üê SignalR Event "ReceiveMessage"
  - DisplayMessage(messageDto)
  - ScrollToEnd()
```

### 6. –°–∫—Ä–æ–ª–ª –≤–≤–µ—Ä—Ö (–ø–æ–¥–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏):
```
User scrolls ‚Üí ScrollViewer.Offset.Y < 50px
Client ‚Üí OnChatScrollChanged()
  if (!_isLoadingHistory && _hasMoreMessages)
    ‚Üí LoadMoreHistoryAsync()

Client ‚Üí GET /api/chats/1/messages?limit=30&before=2025-12-04T10:00:00Z
Server ‚Üí MongoDB: Find({ ChatRoomId: 1, SentAt: { $lt: cursor } }).Limit(30)
Client ‚Üê 200 OK { Messages: [...], Pagination: { HasMore: true } }

Client:
  1. anchorItem = ChatMessagesPanel.Children[0]
  2. Insert messages at index 0
  3. RunJobs(DispatcherPriority.Layout) // —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –ø–µ—Ä–µ—Å—á–µ—Ç
  4. ScrollViewer.Offset = anchorItem.Bounds.Y
  ‚Üí Smooth scroll, no jumps!
```

### 7. –£–¥–∞–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Å reply:
```
User ‚Üí Right-click ‚Üí Delete
Client ‚Üí DELETE /api/chats/1/messages/abc123
Server (MessagesController):
  1. MessageService.DeleteMessageAsync("abc123")
     - MongoDB.DeleteOneAsync({ _id: "abc123" })
     - ClearReplyReferencesAsync() ‚Üí returns ["xyz789", "def456"]
  2. SignalR broadcast:
     Clients.Group("chat_1").SendAsync("MessageDeleted", "abc123")
     Clients.Group("chat_1").SendAsync("RepliesCleared", ["xyz789", "def456"])

Client (–≤—Å–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã–µ):
  Event "MessageDeleted":
    - RemoveMessageFromUI(abc123)
    - _messageCache.Remove(abc123)
  Event "RepliesCleared":
    - RemoveReplyUI(xyz789)
    - RemoveReplyUI(def456)
```

---

## üéØ –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—é

### Redis Pub/Sub Migration (–ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–æ):

**–°–µ–π—á–∞—Å (SignalR Groups):**
```csharp
await Groups.AddToGroupAsync(connectionId, "chat_1");
await Clients.Group("chat_1").SendAsync("ReceiveMessage", msg);
```

**–ü–æ—Å–ª–µ (Redis):**
```csharp
await _redis.SubscribeAsync("chat_1", (channel, message) => { ... });
await _redis.PublishAsync("chat_1", JsonSerializer.Serialize(msg));
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ Redis:**
- –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å —á–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ—Ä–≤–µ—Ä–æ–≤
- –ü–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–π
- –ë–æ–ª–µ–µ –Ω–∏–∑–∫–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞

---

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### –ò–Ω–¥–µ–∫—Å—ã MongoDB:
```javascript
db.messages.createIndex({ ChatRoomId: 1, SentAt: -1 })
// –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç: Find({ ChatRoomId }) + Sort({ SentAt: -1 })
```

### Batch Loading (Reply References):
```csharp
// ‚ùå N+1 Problem
foreach (var msg in messages) {
    msg.ReplyTo = await GetMessageByIdAsync(msg.ReplyToMessageId);
}

// ‚úÖ Batch Load
var replyIds = messages.Select(m => m.ReplyToMessageId).ToList();
var replies = await GetMessagesByIdsAsync(replyIds);
```

---

## üõ†Ô∏è –û—Ç–ª–∞–¥–∫–∞ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ö–æ–Ω—Å–æ–ª—å —Å–µ—Ä–≤–µ—Ä–∞:
```
[DbInitializer] System user already exists (ID: 1)
[DbInitializer] Global Chat already exists (ID: 1)
[Auto-Join] User 5 joined 3 chat groups
[AuthService] User john added to Global Chat (ID: 1)
```

### –ö–ª–∏–µ–Ω—Ç (System.Diagnostics.Debug):
```csharp
System.Diagnostics.Debug.WriteLine($"Error loading history: {ex.Message}");
```

---

## ‚úÖ –ß–µ–∫–ª–∏—Å—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ —Å—Ç–∞—Ä–æ–≥–æ –∫–æ–¥–∞

–ï—Å–ª–∏ —É —Ç–µ–±—è –±—ã–ª —Å—Ç–∞—Ä—ã–π –∫–æ–¥, –≤–æ—Ç —á—Ç–æ –Ω—É–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å:

### 1. –£–¥–∞–ª–∏—Ç—å SignalR CRUD –º–µ—Ç–æ–¥—ã –∏–∑ ChatHub:
```csharp
// ‚ùå –£–¥–∞–ª–∏—Ç—å:
public async Task SendMessage(...)
public async Task DeleteMessage(...)
public async Task EditMessage(...)
public async Task GetChatHistory(...)
```

### 2. –ó–∞–º–µ–Ω–∏—Ç—å –≤—ã–∑–æ–≤—ã –Ω–∞ REST API:
```csharp
// ‚ùå –ë—ã–ª–æ:
await _hubConnection.InvokeAsync("SendMessage", chatId, content);

// ‚úÖ –°—Ç–∞–ª–æ:
await _messageApiService.SendMessageAsync(chatId, new MessageCreateDto { ... });
```

### 3. –î–æ–±–∞–≤–∏—Ç—å auto-join –≤ OnConnectedAsync:
```csharp
public override async Task OnConnectedAsync()
{
    var userId = GetUserId();
    var chats = await _chatRoomRepository.GetUserChatRoomsAsync(userId);
    
    foreach (var chat in chats)
        await Groups.AddToGroupAsync(Context.ConnectionId, $"chat_{chat.Id}");
    
    await base.OnConnectedAsync();
}
```

### 4. –°–æ–∑–¥–∞—Ç—å DbInitializer –∏ –≤—ã–∑–≤–∞—Ç—å –≤ Program.cs:
```csharp
await DbInitializer.InitializeAsync(dbContext);
```

### 5. –£–±—Ä–∞—Ç—å —Ö–∞—Ä–¥–∫–æ–¥ `const int GLOBAL_CHAT_ID = 1`:
```csharp
// ‚ùå –ë—ã–ª–æ:
var globalChat = await _chatRoomRepository.GetByIdAsync(1);

// ‚úÖ –°—Ç–∞–ª–æ:
var globalChat = await _chatRoomRepository.GetByNameAsync("Global Chat");
```

---

## üéì –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–í—ã —Ä–µ–∞–ª–∏–∑–æ–≤–∞–ª–∏ **production-ready –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É** –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–∞ —Å:

‚úÖ –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ–º –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ (REST + SignalR)  
‚úÖ –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–π –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π (cursor-based)  
‚úÖ –ü–ª–∞–≤–Ω–æ–π –ø–æ–¥–≥—Ä—É–∑–∫–æ–π –∏—Å—Ç–æ—Ä–∏–∏ (RunJobs + anchor tracking)  
‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–µ–π —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (DbInitializer)  
‚úÖ –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å—é –∫ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—é (Redis migration ready)  
‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–æ–π race conditions  
‚úÖ Clean Architecture principles  

**–°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:**
1. –î–æ–±–∞–≤–∏—Ç—å Redis –¥–ª—è –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è
2. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å attachments (—Ñ–∞–π–ª—ã/–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è)
3. –î–æ–±–∞–≤–∏—Ç—å —Ä–µ–∞–∫—Ü–∏–∏ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
4. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å read receipts (–ø—Ä–æ—á–∏—Ç–∞–Ω–æ/–Ω–µ –ø—Ä–æ—á–∏—Ç–∞–Ω–æ)
5. –î–æ–±–∞–≤–∏—Ç—å typing indicators
6. –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å MongoDB –∏–Ω–¥–µ–∫—Å—ã –ø–æ–¥ –Ω–∞–≥—Ä—É–∑–∫—É

---

**–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∞–∫—Ç—É–∞–ª—å–Ω–∞ –Ω–∞:** 4 –¥–µ–∫–∞–±—Ä—è 2025  
**–í–µ—Ä—Å–∏—è –ø—Ä–æ–µ–∫—Ç–∞:** v1.0.0
